<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema TMA/TMR</title>
    <link rel="stylesheet" href="css/admin.css?v=8.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="admin-page">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ†Ô∏è Painel Administrativo</h1>
            <p>Sistema TMA/TMR - Gest√£o Completa</p>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsuarios">-</div>
                <div class="stat-label">Total de Usu√°rios</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRegistros">-</div>
                <div class="stat-label">Total de Registros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tmaGeral">-</div>
                <div class="stat-label">TMA M√©dio Geral</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tmrGeral">-</div>
                <div class="stat-label">TMR M√©dio Geral</div>
            </div>
        </div>

        <!-- Abas -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('usuarios')">üë• Usu√°rios</button>
            <button class="tab" onclick="showTab('graficos')">üìä Gr√°ficos</button>
            <button class="tab" onclick="showTab('relatorios')">üìã Relat√≥rios</button>
            <button class="tab" onclick="showTab('top-tempos')">üèÜ Top 10</button>
        </div>

        <!-- Aba Usu√°rios -->
        <div id="usuarios" class="tab-content active">
            <h2>Gerenciamento de Usu√°rios</h2>
            <div id="usuariosList" class="loading">Carregando usu√°rios...</div>
        </div>

        <!-- Aba Gr√°ficos -->
        <div id="graficos" class="tab-content">
            <h2>An√°lise de Dados</h2>
            
            <div class="chart-container">
                <h3>TMA/TMR por PDV</h3>
                <canvas id="chartPDV"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Evolu√ß√£o Temporal (√öltimos 30 dias)</h3>
                <canvas id="chartTemporal"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Top 10 Operadores</h3>
                <canvas id="chartOperadores"></canvas>
            </div>
        </div>

        <!-- Aba Relat√≥rios -->
        <div id="relatorios" class="tab-content">
            <h2>Relat√≥rios Detalhados</h2>
            <div id="relatoriosContent">
                <h3>Relat√≥rio por PDV</h3>
                <div id="relatorioPDV"></div>
                
                <h3>Top Usu√°rios</h3>
                <div id="relatorioUsuarios"></div>
            </div>
        </div>

        <!-- Aba Top 10 -->
        <div id="top-tempos" class="tab-content">
            <h2>üèÜ Top 10 - Melhores e Piores Tempos</h2>
            <div class="top-container">
                <div class="top-section">
                    <h3>‚úÖ Top 10 Melhores TMA (Menores Tempos)</h3>
                    <div id="melhoresTMA" class="loading">Carregando...</div>
                </div>
                
                <div class="top-section">
                    <h3>‚ö†Ô∏è Top 10 Piores TMA (Maiores Tempos)</h3>
                    <div id="pioresTMA" class="loading">Carregando...</div>
                </div>
                
                <div class="top-section">
                    <h3>‚úÖ Top 10 Melhores TMR (Menores Tempos)</h3>
                    <div id="melhoresTMR" class="loading">Carregando...</div>
                </div>
                
                <div class="top-section">
                    <h3>‚ö†Ô∏è Top 10 Piores TMR (Maiores Tempos)</h3>
                    <div id="pioresTMR" class="loading">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};
        let charts = {};

        // Fun√ß√£o para mostrar abas
        function showTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            
            // Carregar dados espec√≠ficos da aba
            if (tabName === 'graficos') {
                carregarGraficos();
            } else if (tabName === 'relatorios') {
                carregarRelatorios();
            } else if (tabName === 'top-tempos') {
                carregarTopTempos();
            }
        }

        // Carregar estat√≠sticas gerais
        async function carregarStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                document.getElementById('totalUsuarios').textContent = data.total_usuarios;
                document.getElementById('totalRegistros').textContent = data.total_registros;
                document.getElementById('tmaGeral').textContent = data.tma_geral + 's';
                document.getElementById('tmrGeral').textContent = data.tmr_geral + 's';
                
                currentData.stats = data;
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                document.getElementById('statsGrid').innerHTML = 
                    '<div class="error">Erro ao carregar estat√≠sticas: ' + error.message + '</div>';
            }
        }

        // Carregar usu√°rios
        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/admin/usuarios');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                const container = document.getElementById('usuariosList');
                container.innerHTML = '';
                
                data.usuarios.forEach(usuario => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <div class="user-header">
                            <div class="user-info">
                                <strong>${usuario.nome}</strong>
                                ${usuario.is_admin ? '<span class="user-badge">ADMIN</span>' : ''}
                                <span class="user-badge">${usuario.total_registros} registros</span>
                            </div>
                            <div class="user-actions">
                                <button class="btn-info" onclick="toggleUserDetails(${usuario.id})">
                                    <span id="toggle-${usuario.id}">Ver Detalhes</span>
                                </button>
                                ${!usuario.is_admin ? `<button class="btn-danger" onclick="deletarUsuario(${usuario.id}, '${usuario.nome}')">Deletar</button>` : ''}
                            </div>
                        </div>
                        <div id="details-${usuario.id}" style="display: none; padding: 15px;">
                            ${usuario.registros && usuario.registros.length > 0 ? `
                                <table class="registros-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Operador</th>
                                            <th>PDV</th>
                                            <th>TMA</th>
                                            <th>TMR</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${usuario.registros.map(registro => `
                                            <tr id="registro-${registro.id}">
                                                <td>${registro.data_registro}</td>
                                                <td>${registro.nome_operador}</td>
                                                <td>${registro.numero_pdv}</td>
                                                <td>${registro.tma}s</td>
                                                <td>${registro.tmr}s</td>
                                                <td>
                                                    <button class="btn-danger" onclick="deletarRegistro(${registro.id})">Deletar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p>Nenhum registro encontrado.</p>'}
                        </div>
                    `;
                    container.appendChild(userCard);
                });
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuariosList').innerHTML = 
                    '<div class="error">Erro ao carregar usu√°rios: ' + error.message + '</div>';
            }
        }

        // Toggle detalhes do usu√°rio
        function toggleUserDetails(userId) {
            const details = document.getElementById(`details-${userId}`);
            const toggle = document.getElementById(`toggle-${userId}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                toggle.textContent = 'Ocultar Detalhes';
            } else {
                details.style.display = 'none';
                toggle.textContent = 'Ver Detalhes';
            }
        }

        // Deletar usu√°rio
        async function deletarUsuario(userId, userName) {
            if (!confirm(`Tem certeza que deseja deletar o usu√°rio "${userName}" e todos seus registros?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/usuarios/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                alert(data.message);
                await carregarUsuarios();
                await carregarStats();
                
            } catch (error) {
                alert('Erro ao deletar usu√°rio: ' + error.message);
            }
        }

        // Deletar registro
        async function deletarRegistro(registroId) {
            if (!confirm('Tem certeza que deseja deletar este registro?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/registros/${registroId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                // Remover linha da tabela
                const row = document.getElementById(`registro-${registroId}`);
                if (row) {
                    row.remove();
                }
                
                await carregarStats();
                alert(data.message);
                
            } catch (error) {
                alert('Erro ao deletar registro: ' + error.message);
            }
        }

        // Carregar gr√°ficos
        async function carregarGraficos() {
            try {
                const response = await fetch('/api/admin/graficos');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                // Gr√°fico PDV
                criarGraficoPDV(data.pdv_data);
                
                // Gr√°fico Temporal
                criarGraficoTemporal(data.evolucao_temporal);
                
                // Gr√°fico Operadores
                criarGraficoOperadores(data.operadores_data);
                
            } catch (error) {
                console.error('Erro ao carregar gr√°ficos:', error);
            }
        }

        // Criar gr√°fico por PDV
        function criarGraficoPDV(data) {
            const ctx = document.getElementById('chartPDV').getContext('2d');
            
            if (charts.pdv) {
                charts.pdv.destroy();
            }
            
            charts.pdv = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `PDV ${d.pdv}`),
                    datasets: [
                        {
                            label: 'TMA M√©dio (s)',
                            data: data.map(d => d.tma_medio),
                            backgroundColor: 'rgba(9, 9, 121, 0.8)',
                            borderColor: 'rgba(9, 9, 121, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'TMR M√©dio (s)',
                            data: data.map(d => d.tmr_medio),
                            backgroundColor: 'rgba(46, 56, 59, 0.8)',
                            borderColor: 'rgba(46, 56, 59, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tempo (segundos)',
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            },
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        }
                    }
                }
            });
        }

        // Criar gr√°fico temporal
        function criarGraficoTemporal(data) {
            const ctx = document.getElementById('chartTemporal').getContext('2d');
            
            if (charts.temporal) {
                charts.temporal.destroy();
            }
            
            charts.temporal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.data),
                    datasets: [
                        {
                            label: 'TMA M√©dio (s)',
                            data: data.map(d => d.tma_medio),
                            borderColor: 'rgba(9, 9, 121, 1)',
                            backgroundColor: 'rgba(9, 9, 121, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(9, 9, 121, 1)',
                            pointBorderColor: 'rgba(255, 255, 255, 1)',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        },
                        {
                            label: 'TMR M√©dio (s)',
                            data: data.map(d => d.tmr_medio),
                            borderColor: 'rgba(46, 56, 59, 1)',
                            backgroundColor: 'rgba(46, 56, 59, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(46, 56, 59, 1)',
                            pointBorderColor: 'rgba(255, 255, 255, 1)',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tempo (segundos)',
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            },
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        }
                    }
                }
            });
        }

        // Criar gr√°fico de operadores
        function criarGraficoOperadores(data) {
            const ctx = document.getElementById('chartOperadores').getContext('2d');
            
            if (charts.operadores) {
                charts.operadores.destroy();
            }
            
            charts.operadores = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: data.map(d => d.operador),
                    datasets: [{
                        label: 'Total de Registros',
                        data: data.map(d => d.total_registros),
                        backgroundColor: 'rgba(9, 9, 121, 0.8)',
                        borderColor: 'rgba(9, 9, 121, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Registros',
                                color: 'rgba(2, 0, 36, 1)',
                                font: {
                                    weight: 600
                                }
                            },
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(46, 56, 59, 1)'
                            }
                        }
                    }
                }
            });
        }

        // Carregar relat√≥rios
        function carregarRelatorios() {
            if (!currentData.stats) return;
            
            // Relat√≥rio por PDV
            const relatorioPDV = document.getElementById('relatorioPDV');
            relatorioPDV.innerHTML = `
                <table class="registros-table">
                    <thead>
                        <tr>
                            <th>PDV</th>
                            <th>Total de Registros</th>
                            <th>TMA M√©dio</th>
                            <th>TMR M√©dio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentData.stats.registros_por_pdv.map(pdv => `
                            <tr>
                                <td>PDV ${pdv.pdv}</td>
                                <td>${pdv.total}</td>
                                <td>${pdv.tma_medio}s</td>
                                <td>${pdv.tmr_medio}s</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // Relat√≥rio de usu√°rios
            const relatorioUsuarios = document.getElementById('relatorioUsuarios');
            relatorioUsuarios.innerHTML = `
                <table class="registros-table">
                    <thead>
                        <tr>
                            <th>Usu√°rio</th>
                            <th>Total de Registros</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentData.stats.usuarios_top.map(user => `
                            <tr>
                                <td>${user.nome}</td>
                                <td>${user.total_registros}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Carregar Top 10 de melhores e piores tempos
        async function carregarTopTempos() {
            try {
                const response = await fetch('/api/admin/top-tempos');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                // Melhores TMA
                const melhoresTMA = document.getElementById('melhoresTMA');
                melhoresTMA.innerHTML = `
                    <table class="top-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Operador</th>
                                <th>PDV</th>
                                <th>TMA</th>
                                <th>Data</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.melhores_tma.map((registro, index) => `
                                <tr class="top-melhor">
                                    <td class="pos-numero">${index + 1}¬∞</td>
                                    <td>${registro.nome_operador}</td>
                                    <td>PDV ${registro.numero_pdv}</td>
                                    <td class="tempo-destaque">${registro.tma} min/cupom</td>
                                    <td>${registro.data_registro}</td>
                                    <td>${registro.usuario_nome}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Piores TMA
                const pioresTMA = document.getElementById('pioresTMA');
                pioresTMA.innerHTML = `
                    <table class="top-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Operador</th>
                                <th>PDV</th>
                                <th>TMA</th>
                                <th>Data</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.piores_tma.map((registro, index) => `
                                <tr class="top-pior">
                                    <td class="pos-numero">${index + 1}¬∞</td>
                                    <td>${registro.nome_operador}</td>
                                    <td>PDV ${registro.numero_pdv}</td>
                                    <td class="tempo-destaque">${registro.tma} min/cupom</td>
                                    <td>${registro.data_registro}</td>
                                    <td>${registro.usuario_nome}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Melhores TMR
                const melhoresTMR = document.getElementById('melhoresTMR');
                melhoresTMR.innerHTML = `
                    <table class="top-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Operador</th>
                                <th>PDV</th>
                                <th>TMR</th>
                                <th>Data</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.melhores_tmr.map((registro, index) => `
                                <tr class="top-melhor">
                                    <td class="pos-numero">${index + 1}¬∞</td>
                                    <td>${registro.nome_operador}</td>
                                    <td>PDV ${registro.numero_pdv}</td>
                                    <td class="tempo-destaque">${registro.tmr} seg/item</td>
                                    <td>${registro.data_registro}</td>
                                    <td>${registro.usuario_nome}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Piores TMR
                const pioresTMR = document.getElementById('pioresTMR');
                pioresTMR.innerHTML = `
                    <table class="top-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Operador</th>
                                <th>PDV</th>
                                <th>TMR</th>
                                <th>Data</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.piores_tmr.map((registro, index) => `
                                <tr class="top-pior">
                                    <td class="pos-numero">${index + 1}¬∞</td>
                                    <td>${registro.nome_operador}</td>
                                    <td>PDV ${registro.numero_pdv}</td>
                                    <td class="tempo-destaque">${registro.tmr} seg/item</td>
                                    <td>${registro.data_registro}</td>
                                    <td>${registro.usuario_nome}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar Top 10:', error);
                document.querySelectorAll('#top-tempos .loading').forEach(el => {
                    el.innerHTML = '<div class="error">Erro ao carregar dados: ' + error.message + '</div>';
                });
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/login';
            }
        }

        // Inicializar p√°gina
        async function init() {
            await carregarStats();
            await carregarUsuarios();
        }

        // Carregar dados ao iniciar
        init();
    </script>
</body>
</html>
