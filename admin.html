<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="device-width, initial-scale=1.0">
    <title>Admin - Sistema TMA/TMR</title>
    <link rel="stylesheet" href="css/admin.css?v=2.1">
    <link rel="stylesheet" href="css/admin-alert.css?v=1.1">
    <link rel="stylesheet" href="css/ranking-compact.css?v=1.1">
    <link rel="stylesheet" href="css/operador-search.css?v=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/script.js?v=1.2"></script>
</head>
<body class="admin-page">
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üõ†Ô∏è Painel Administrativo</h1>
            <p>Sistema TMA/TMR - Gest√£o Completa</p>
            <button class="admin-logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Stats -->
        <div class="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalUsuarios">-</div>
                <div class="admin-stat-label">Total de Usu√°rios</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalRegistros">-</div>
                <div class="admin-stat-label">Total de Registros</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="tmaGeral">-</div>
                <div class="admin-stat-label">TMA M√©dio Geral</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="tmrGeral">-</div>
                <div class="admin-stat-label">TMR M√©dio Geral</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="admin-nav">
            <button class="admin-nav-btn active" onclick="showSection('atencao')">‚ö†Ô∏è Aten√ß√£o</button>
            <button class="admin-nav-btn" onclick="showSection('usuarios')">üë• Usu√°rios</button>
            <button class="admin-nav-btn" onclick="showSection('top-tempos')">üèÜ Top 10</button>
            <button class="admin-nav-btn" onclick="showSection('relatorios')">üìã Relat√≥rios</button>
        </div>

        <!-- Operadores que precisam de aten√ß√£o -->
        <div id="atencao" class="admin-content active">
            <h2>‚ö†Ô∏è Monitoramento de Desempenho</h2>
            <p class="secao-descricao">Este painel mostra operadores que precisam de aten√ß√£o especial com base na an√°lise autom√°tica de tempos.</p>
            
            <div class="controles-alerta">
                <div class="pesquisa-operador">
                    <label for="pesquisa-nome-operador">üîç Buscar por nome:</label>
                    <input type="text" id="pesquisa-nome-operador" placeholder="Digite o nome do operador">
                </div>
                <div class="filtros-alerta">
                    <label for="filtro-criticidade">üìä Filtrar por n√≠vel:</label>
                    <select id="filtro-criticidade">
                        <option value="todos">Todos os n√≠veis</option>
                        <option value="alta">üî¥ Alta criticidade</option>
                        <option value="media">üü† M√©dia criticidade</option>
                        <option value="baixa">üü° Baixa criticidade</option>
                    </select>
                </div>
                <button class="atualizar-alerta" onclick="carregarRegistrosAdmin()">üîÑ Atualizar Dados</button>
            </div>
            <div id="painel-operadores-alerta" class="secao-alerta">
                <div class="carregando">
                    <div class="loader"></div>
                    Analisando dados dos operadores...
                </div>
            </div>
            
            <div class="legenda-criticidade">
                <h4>Legenda de criticidade:</h4>
                <div class="legenda-item"><span class="indicador-alto"></span> <strong>Alta:</strong> Ambos os tempos fora da meta ou mais de 70% dos registros problem√°ticos</div>
                <div class="legenda-item"><span class="indicador-medio"></span> <strong>M√©dia:</strong> Um dos tempos fora da meta ou tend√™ncia de piora</div>
                <div class="legenda-item"><span class="indicador-baixo"></span> <strong>Baixa:</strong> Pr√≥ximo ao limite da meta ou recentemente fora da meta</div>
            </div>
        </div>
        
        <!-- Usu√°rios Section -->
        <div id="usuarios" class="admin-content">
            <h2>Gerenciamento de Usu√°rios</h2>
            <div id="usuariosList" class="admin-loading">Carregando usu√°rios...</div>
        </div>

        <!-- Top 10 Section -->
        <div id="top-tempos" class="admin-content">
            <h2>üèÜ Ranking de Tempos - Melhores e Piores</h2>
            <div class="ranking-info">
                <p><strong>üìè Crit√©rios:</strong></p>
                <p>‚Ä¢ <span class="meta-good">TMA ‚â§ 1,32 min (79.2s)</span> e <span class="meta-good">TMR ‚â§ 6s</span> = Melhores Tempos</p>
                <p>‚Ä¢ <span class="meta-bad">TMA > 1,32 min (79.2s)</span> e <span class="meta-bad">TMR > 6s</span> = Piores Tempos</p>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="ranking-tabs">
                <button class="ranking-tab active" onclick="showRankingPeriod('geral')">üìä Ranking Geral</button>
                <button class="ranking-tab" onclick="showRankingPeriod('diario')">üìÖ Ranking do Dia</button>
            </div>
            
            <!-- Ranking Geral -->
            <div id="ranking-geral" class="ranking-period active">
                <h3>üìä Todos os Tempos Registrados</h3>
                
                <div class="ranking-grid">
                    <!-- Melhores Tempos TMA -->
                    <div class="ranking-card good">
                        <div class="ranking-header">
                            <h4>üéØ Melhores TMA (‚â§ 1,32)</h4>
                            <span class="meta-badge good">Meta: 1.32 min</span>
                        </div>
                        <div id="melhoresTMAGeral" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Piores Tempos TMA -->
                    <div class="ranking-card bad">
                        <div class="ranking-header">
                            <h4>‚ö†Ô∏è Piores TMA (> 1,32)</h4>
                            <span class="meta-badge bad">Acima de 1.32 min</span>
                        </div>
                        <div id="pioresTMAGeral" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Melhores Tempos TMR -->
                    <div class="ranking-card good">
                        <div class="ranking-header">
                            <h4>üéØ Melhores TMR (‚â§ 6s)</h4>
                            <span class="meta-badge good">Meta: 6s</span>
                        </div>
                        <div id="melhoresTMRGeral" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Piores Tempos TMR -->
                    <div class="ranking-card bad">
                        <div class="ranking-header">
                            <h4>‚ö†Ô∏è Piores TMR (> 6s)</h4>
                            <span class="meta-badge bad">Acima de 6s</span>
                        </div>
                        <div id="pioresTMRGeral" class="ranking-content">Carregando...</div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking Di√°rio -->
            <div id="ranking-diario" class="ranking-period">
                <h3>üìÖ Ranking por Data</h3>
                
                <!-- Seletor de Data -->
                <div class="date-selector">
                    <label for="seletorData">üìÖ Selecionar Data:</label>
                    <input type="date" id="seletorData" />
                    <button id="botaoHoje" class="date-today-btn">üìÖ Hoje</button>
                </div>
                
                <div class="day-info">
                    <p id="periodoAtual">üìÖ Hoje</p>
                    <p>Total de registros: <span id="totalRegistrosDia">-</span></p>
                </div>
                
                <div class="ranking-grid">
                    <!-- Melhores Tempos TMA Hoje -->
                    <div class="ranking-card good">
                        <div class="ranking-header">
                            <h4>üéØ Melhores TMA Hoje (‚â§ 1,32)</h4>
                            <span class="meta-badge good">Meta: 1.32 min</span>
                        </div>
                        <div id="melhoresTMAHoje" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Piores Tempos TMA Hoje -->
                    <div class="ranking-card bad">
                        <div class="ranking-header">
                            <h4>‚ö†Ô∏è Piores TMA Hoje (> 1,32)</h4>
                            <span class="meta-badge bad">Acima de 1.32 min</span>
                        </div>
                        <div id="pioresTMAHoje" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Melhores Tempos TMR Hoje -->
                    <div class="ranking-card good">
                        <div class="ranking-header">
                            <h4>üéØ Melhores TMR Hoje (‚â§ 6s)</h4>
                            <span class="meta-badge good">Meta: 6s</span>
                        </div>
                        <div id="melhoresTMRHoje" class="ranking-content">Carregando...</div>
                    </div>
                    
                    <!-- Piores Tempos TMR Hoje -->
                    <div class="ranking-card bad">
                        <div class="ranking-header">
                            <h4>‚ö†Ô∏è Piores TMR Hoje (> 6s)</h4>
                            <span class="meta-badge bad">Acima de 6s</span>
                        </div>
                        <div id="pioresTMRHoje" class="ranking-content">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Section -->
        <div id="relatorios" class="admin-content">
            <h2>üìã Relat√≥rios e Gr√°ficos</h2>
            
            <!-- Filtros simples -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <label for="reportPeriod">üìÖ Per√≠odo: </label>
                <select id="reportPeriod" style="padding: 8px; margin-right: 10px;">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30" selected>√öltimos 30 dias</option>
                </select>
                <button onclick="loadCharts()" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Atualizar</button>
            </div>
            
            <!-- Gr√°ficos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h3>üìä TMA M√©dio por Dia</h3>
                    <canvas id="tmaChart" style="max-height: 300px;"></canvas>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h3>üìä TMR M√©dio por Dia</h3>
                    <canvas id="tmrChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h3>üéØ Conformidade TMA</h3>
                    <canvas id="tmaDonutChart" style="max-height: 300px;"></canvas>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h3>üéØ Conformidade TMR</h3>
                    <canvas id="tmrDonutChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = {};

        // Show section
        function showSection(sectionName) {
            console.log('Alternando para a se√ß√£o:', sectionName);
            
            // Remove active from all nav buttons
            document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
            
            // Activate selected
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback para quando n√£o tem evento
                document.querySelector(`.admin-nav-btn[onclick*="${sectionName}"]`).classList.add('active');
            }
            
            document.getElementById(sectionName).classList.add('active');
            
            // Load specific data
            if (sectionName === 'atencao') {
                console.log('Carregando dados de operadores que precisam de aten√ß√£o...');
                carregarRegistrosAdmin();
            } else if (sectionName === 'top-tempos') {
                loadRankingGeral();
                updateToday();
            } else if (sectionName === 'relatorios') {
                loadReports();
            }
        }

        // Show ranking period
        function showRankingPeriod(period) {
            // Remove active from all ranking tabs
            document.querySelectorAll('.ranking-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.ranking-period').forEach(content => content.classList.remove('active'));
            
            // Activate selected
            event.target.classList.add('active');
            document.getElementById(`ranking-${period}`).classList.add('active');
            
            // Load data
            if (period === 'geral') {
                loadRankingGeral();
            } else if (period === 'diario') {
                updateToday();
                loadRankingDiario();
            }
        }

        // Update today's date
        function updateToday() {
            const today = new Date();
            const isoDate = today.toISOString().split('T')[0];
            
            // Definir data de hoje no input
            document.getElementById('seletorData').value = isoDate;
        }

        // Carregar ranking para hoje
        function carregarHoje() {
            console.log('üè† Carregando dados de hoje...');
            updateToday();
            document.getElementById('periodoAtual').textContent = 'üìÖ Hoje';
            loadRankingDiario();
        }

        // Carregar ranking por data selecionada
        function carregarRankingPorData() {
            const dataInput = document.getElementById('seletorData');
            const dataSelecionada = dataInput.value;
            
            if (!dataSelecionada) {
                alert('‚ö†Ô∏è Por favor, selecione uma data v√°lida!');
                return;
            }
            
            console.log('üìÖ Carregando ranking para data:', dataSelecionada);
            
            // Update the period display
            const [ano, mes, dia] = dataSelecionada.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            document.getElementById('periodoAtual').textContent = `üìÖ Data: ${dataFormatada}`;
            
            // Carregar dados da data espec√≠fica
            loadRankingPorData(dataSelecionada);
        }

        // Load stats
        async function loadStats() {
            try {
                console.log('üìä Carregando estat√≠sticas...');
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                document.getElementById('totalUsuarios').textContent = data.total_usuarios || '0';
                document.getElementById('totalRegistros').textContent = data.total_registros || '0';
                document.getElementById('tmaGeral').textContent = (data.tma_geral || '0') + 's';
                document.getElementById('tmrGeral').textContent = (data.tmr_geral || '0') + 's';
                
                currentData.stats = data;
                console.log('‚úÖ Estat√≠sticas carregadas');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                // Valores padr√£o se houver erro
                document.getElementById('totalUsuarios').textContent = '0';
                document.getElementById('totalRegistros').textContent = '0';
                document.getElementById('tmaGeral').textContent = '0s';
                document.getElementById('tmrGeral').textContent = '0s';
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/usuarios');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                const container = document.getElementById('usuariosList');
                container.innerHTML = '';
                
                if (data.usuarios.length === 0) {
                    container.innerHTML = '<div class="admin-empty">Nenhum usu√°rio encontrado.</div>';
                    return;
                }
                
                // Criar container da lista
                const listContainer = document.createElement('div');
                listContainer.className = 'usuarios-list';
                
                data.usuarios.forEach(usuario => {
                    const userItem = document.createElement('div');
                    userItem.className = 'usuario-item';
                    
                    const iniciais = usuario.nome.split(' ').map(n => n[0]).join('').substring(0, 2);
                    
                    userItem.innerHTML = `
                        <div class="usuario-info">
                            <div class="usuario-avatar">${iniciais}</div>
                            <div class="usuario-details">
                                <div class="usuario-nome">${usuario.nome}</div>
                                <div class="usuario-stats">${usuario.total_registros} registros realizados</div>
                            </div>
                        </div>
                        <div class="usuario-actions">
                            ${usuario.is_admin ? '<span class="usuario-badge admin">Admin</span>' : '<span class="usuario-badge operador">Operador</span>'}
                            <button onclick="viewUserRecords(${usuario.id}, '${usuario.nome}')" style="background: #4f46e5; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üìä Ver</button>
                            ${!usuario.is_admin ? `<button onclick="deleteUser(${usuario.id}, '${usuario.nome}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>` : ''}
                        </div>
                    `;
                    
                    listContainer.appendChild(userItem);
                });
                
                container.appendChild(listContainer);
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuariosList').innerHTML = '<div class="admin-error">Erro ao carregar usu√°rios: ' + error.message + '</div>';
            }
        }

        // Delete user
        async function deleteUser(userId, userName) {
            if (!confirm(`Tem certeza que deseja deletar o usu√°rio "${userName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/usuarios/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                alert(data.message);
                await loadUsers();
                await loadStats();
                
            } catch (error) {
                alert('Erro ao deletar usu√°rio: ' + error.message);
            }
        }

        // Visualizar registros de um usu√°rio
        async function viewUserRecords(userId, userName) {
            try {
                const response = await fetch(`/api/registros/${userId}`);
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                showUserRecordsModal(data, userName, userId);
                
            } catch (error) {
                alert('Erro ao carregar registros: ' + error.message);
            }
        }

        // Mostrar modal com registros do usu√°rio
        function showUserRecordsModal(registros, userName, userId) {
            let modalHtml = `
            <div id="userRecordsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                <div style="background: white; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 10px; overflow: hidden;">
                    <div style="background: #4f46e5; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">üìä Registros de ${userName}</h3>
                        <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; max-height: 60vh;">
            `;
            
            if (!registros || registros.length === 0) {
                modalHtml += '<p style="text-align: center; color: #6b7280; font-size: 1.1rem; padding: 40px;">üì≠ Nenhum registro encontrado</p>';
            } else {
                modalHtml += `
                <div style="margin-bottom: 20px; color: #6b7280;">
                    Total de registros: <strong>${registros.length}</strong>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">Data/Hora</th>
                                <th style="padding: 12px; text-align: left;">Operador</th>
                                <th style="padding: 12px; text-align: center;">PDV</th>
                                <th style="padding: 12px; text-align: center;">TMA</th>
                                <th style="padding: 12px; text-align: center;">TMR</th>
                                <th style="padding: 12px; text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                registros.forEach((registro, index) => {
                    const dataHora = registro.data_registro.split('-').reverse().join('/');
                    const tmaClass = registro.tma <= 1.32 ? 'color: #059669; font-weight: bold;' : 'color: #dc2626;';
                    const tmrClass = registro.tmr <= 172 ? 'color: #059669; font-weight: bold;' : 'color: #dc2626;';
                    const bgColor = index % 2 === 0 ? '#f8fafc' : 'white';
                    
                    modalHtml += `
                        <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 10px;">${dataHora}</td>
                            <td style="padding: 10px;">${registro.nome_operador}</td>
                            <td style="padding: 10px; text-align: center;">${registro.numero_pdv}</td>
                            <td style="padding: 10px; text-align: center; ${tmaClass}">${registro.tma} min</td>
                            <td style="padding: 10px; text-align: center; ${tmrClass}">${registro.tmr}s</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="deleteRecord(${registro.id}, '${userName}', ${userId})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è Deletar</button>
                            </td>
                        </tr>
                    `;
                });
                
                modalHtml += `
                        </tbody>
                    </table>
                </div>
                `;
            }
            
            modalHtml += `
                    </div>
                    <div style="background: #f8fafc; padding: 15px; text-align: center; border-top: 1px solid #e2e8f0;">
                        <button onclick="closeModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Fechar</button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Fechar modal
        function closeModal() {
            const modal = document.getElementById('userRecordsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Deletar registro espec√≠fico
        async function deleteRecord(recordId, userName, userId) {
            if (!confirm(`Tem certeza que deseja deletar este registro?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/registros/${recordId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }
                
                alert('‚úÖ Registro deletado com sucesso!');
                
                // Fechar modal atual e reabrir com dados atualizados
                closeModal();
                setTimeout(() => {
                    viewUserRecords(userId, userName);
                }, 100);
                
                // Atualizar estat√≠sticas
                await loadStats();
                await loadUsers();
                
            } catch (error) {
                alert('‚ùå Erro ao deletar registro: ' + error.message);
            }
        }

        // Load Ranking Geral
        async function loadRankingGeral() {
            try {
                const response = await fetch('/api/admin/top-tempos');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }

                console.log('üîç DEBUG - Ranking Geral:', data);
                
                // Melhores TMA (‚â§79.2s)
                const melhoresTMAGeral = document.getElementById('melhoresTMAGeral');
                if (data.melhores_tma.length === 0) {
                    melhoresTMAGeral.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMA ‚â§ 1,32 encontrado</div>';
                } else {
                    melhoresTMAGeral.innerHTML = createRankingTable(
                        data.melhores_tma.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tma} min`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'good'
                        }))
                    );
                }
                
                // Piores TMA (>79.2s)
                const pioresTMAGeral = document.getElementById('pioresTMAGeral');
                if (data.piores_tma.length === 0) {
                    pioresTMAGeral.innerHTML = '<div class="excellent-ranking">üéâ Excelente! Todos os TMA est√£o dentro da meta!</div>';
                } else {
                    pioresTMAGeral.innerHTML = createRankingTable(
                        data.piores_tma.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tma} min`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'bad'
                        }))
                    );
                }
                
                // Melhores TMR (‚â§6s)
                const melhoresTMRGeral = document.getElementById('melhoresTMRGeral');
                if (data.melhores_tmr.length === 0) {
                    melhoresTMRGeral.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMR ‚â§ 6s encontrado</div>';
                } else {
                    melhoresTMRGeral.innerHTML = createRankingTable(
                        data.melhores_tmr.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tmr}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'good'
                        }))
                    );
                }
                
                // Piores TMR (>6s)
                const pioresTMRGeral = document.getElementById('pioresTMRGeral');
                if (data.piores_tmr.length === 0) {
                    pioresTMRGeral.innerHTML = '<div class="excellent-ranking">üéâ Excelente! Todos os TMR est√£o dentro da meta!</div>';
                } else {
                    pioresTMRGeral.innerHTML = createRankingTable(
                        data.piores_tmr.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tmr}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'bad'
                        }))
                    );
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking geral:', error);
                document.querySelectorAll('#ranking-geral .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        // Load Ranking por Data Espec√≠fica
        async function loadRankingPorData(dataSelecionada) {
            try {
                const response = await fetch(`/api/admin/top-tempos-diario?data=${dataSelecionada}`);
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }

                console.log('üîç DEBUG - Ranking por Data:', data);
                console.log('üîç DEBUG - Data consultada:', dataSelecionada);
                
                // Update day info
                document.getElementById('totalRegistrosDia').textContent = data.total_registros_hoje;
                
                // Melhores TMA da Data (‚â§79.2s)
                const melhoresTMAHoje = document.getElementById('melhoresTMAHoje');
                if (!data.melhores_tma_hoje || data.melhores_tma_hoje.length === 0) {
                    melhoresTMAHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMA ‚â§ 1,32 nesta data</div>';
                } else {
                    const rankingData = data.melhores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMA da Data (>79.2s)
                const pioresTMAHoje = document.getElementById('pioresTMAHoje');
                if (!data.piores_tma_hoje || data.piores_tma_hoje.length === 0) {
                    pioresTMAHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMA acima da meta nesta data!</div>';
                } else {
                    const rankingData = data.piores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Melhores TMR da Data (‚â§6s)
                const melhoresTMRHoje = document.getElementById('melhoresTMRHoje');
                if (!data.melhores_tmr_hoje || data.melhores_tmr_hoje.length === 0) {
                    melhoresTMRHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMR ‚â§ 6s nesta data</div>';
                } else {
                    const rankingData = data.melhores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMR da Data (>6s)
                const pioresTMRHoje = document.getElementById('pioresTMRHoje');
                if (!data.piores_tmr_hoje || data.piores_tmr_hoje.length === 0) {
                    pioresTMRHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMR acima da meta nesta data!</div>';
                } else {
                    const rankingData = data.piores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking por data:', error);
                document.querySelectorAll('#ranking-diario .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        // Load Ranking Di√°rio
        async function loadRankingDiario() {
            try {
                const response = await fetch('/api/admin/top-tempos-diario');
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error(data.erro);
                }

                console.log('üîç DEBUG - Ranking Di√°rio:', data);
                console.log('üîç DEBUG - Melhores TMA Hoje:', data.melhores_tma_hoje);
                console.log('üîç DEBUG - Piores TMA Hoje:', data.piores_tma_hoje);
                console.log('üîç DEBUG - Meta TMA:', data.meta_tma);
                console.log('üîç DEBUG - Total registros:', data.total_registros_hoje);
                
                // Update day info
                document.getElementById('totalRegistrosDia').textContent = data.total_registros_hoje;
                
                // Melhores TMA Hoje (‚â§79.2s)
                const melhoresTMAHoje = document.getElementById('melhoresTMAHoje');
                if (!data.melhores_tma_hoje || data.melhores_tma_hoje.length === 0) {
                    melhoresTMAHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMA ‚â§ 1,32 hoje</div>';
                } else {
                    const rankingData = data.melhores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMA Hoje (>79.2s)
                const pioresTMAHoje = document.getElementById('pioresTMAHoje');
                if (!data.piores_tma_hoje || data.piores_tma_hoje.length === 0) {
                    pioresTMAHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMA acima da meta hoje!</div>';
                } else {
                    const rankingData = data.piores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Melhores TMR Hoje (‚â§6s)
                const melhoresTMRHoje = document.getElementById('melhoresTMRHoje');
                if (!data.melhores_tmr_hoje || data.melhores_tmr_hoje.length === 0) {
                    melhoresTMRHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMR ‚â§ 6s hoje</div>';
                } else {
                    const rankingData = data.melhores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMR Hoje (>6s)
                const pioresTMRHoje = document.getElementById('pioresTMRHoje');
                if (!data.piores_tmr_hoje || data.piores_tmr_hoje.length === 0) {
                    pioresTMRHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMR acima da meta hoje!</div>';
                } else {
                    const rankingData = data.piores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking di√°rio:', error);
                document.querySelectorAll('#ranking-diario .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        // Event listeners initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin page loaded - Initializing...');
            
            // Initialize date selector with today's date
            updateToday();
            
            // Load initial data
            init();
            
            // Date selector event listener
            const dataInput = document.getElementById('seletorData');
            if (dataInput) {
                dataInput.addEventListener('change', carregarRankingPorData);
                console.log('üìÖ Date selector listener added');
            }
            
            // Today button event listener
            const botaoHoje = document.getElementById('botaoHoje');
            if (botaoHoje) {
                botaoHoje.addEventListener('click', carregarHoje);
                console.log('üìÖ Today button listener added');
            }
        });

        // Create ranking table helper
        function createRankingTable(rankings) {
            if (rankings.length === 0) {
                return '<div class="empty-ranking">üì≠ Nenhum registro encontrado</div>';
            }
            
            const html = `
                <div class="modern-ranking-table">
                    ${rankings.map(r => `
                        <div class="ranking-data-row ${r.tipo}">
                            <div class="ranking-info-left">
                                <div class="position-badge ${r.tipo}">
                                    ${r.pos === 1 ? 'ü•á' : r.pos === 2 ? 'ü•à' : r.pos === 3 ? 'ü•â' : r.pos + '¬∞'}
                                </div>
                                <div class="ranking-details">
                                    <div class="operador-name">${r.operador}</div>
                                    <div class="ranking-meta">PDV ${r.pdv} ‚Ä¢ ${r.usuario}</div>
                                </div>
                            </div>
                            <div class="ranking-info-right">
                                <div class="tempo-value ${r.tipo}">
                                    ${r.tempo}
                                    ${r.tipo === 'good' ? ' ‚úì' : ' ‚ö†Ô∏è'}
                                </div>
                                ${r.data ? `<div class="data-value">${formatDate(r.data)}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            return html;
        }

        // Helper function to format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                // Simples convers√£o de YYYY-MM-DD para DD/MM/YY
                const [ano, mes, dia] = dateStr.split('-');
                return `${dia}/${mes}/${ano.slice(2)}`;
            } catch (e) {
                return dateStr; // Fallback em caso de erro
            }
        }

        // Load reports
        function loadReports() {
            loadCharts();
        }

        let charts = {};

        function loadCharts() {
            const period = document.getElementById('reportPeriod').value;
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - period * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            fetch(`/api/admin/chart-data?start=${startDate}&end=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.erro) throw new Error(data.erro);
                    createTMAChart(data.tma_por_dia);
                    createTMRChart(data.tmr_por_dia);
                    createTMADonutChart(data.tma_distribution);
                    createTMRDonutChart(data.tmr_distribution);
                })
                .catch(error => {
                    console.error('Erro ao carregar gr√°ficos:', error);
                    alert('Erro ao carregar gr√°ficos: ' + error.message);
                });
        }

        function createTMAChart(data) {
            const ctx = document.getElementById('tmaChart').getContext('2d');
            if (charts.tma) charts.tma.destroy();
            
            charts.tma = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.data.split('-').reverse().join('/')),
                    datasets: [{
                        label: 'TMA M√©dio (min)',
                        data: data.map(d => d.tma_medio),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Meta (1.32 min)',
                        data: data.map(() => 1.32),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createTMRChart(data) {
            const ctx = document.getElementById('tmrChart').getContext('2d');
            if (charts.tmr) charts.tmr.destroy();
            
            charts.tmr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.data.split('-').reverse().join('/')),
                    datasets: [{
                        label: 'TMR M√©dio (s)',
                        data: data.map(d => d.tmr_medio),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Meta (6s)',
                        data: data.map(() => 6),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createTMADonutChart(data) {
            const ctx = document.getElementById('tmaDonutChart').getContext('2d');
            if (charts.tmaDonut) charts.tmaDonut.destroy();
            
            charts.tmaDonut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Dentro da Meta (‚â§ 1.32 min)', 'Acima da Meta (> 1.32 min)'],
                    datasets: [{
                        data: [data.dentro_meta, data.acima_meta],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createTMRDonutChart(data) {
            const ctx = document.getElementById('tmrDonutChart').getContext('2d');
            if (charts.tmrDonut) charts.tmrDonut.destroy();
            
            charts.tmrDonut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Dentro da Meta (‚â§ 6s)', 'Acima da Meta (> 6s)'],
                    datasets: [{
                        data: [data.dentro_meta, data.acima_meta],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/login';
            }
        }

        // Initialize
        async function init() {
            console.log('üöÄ Iniciando admin...');
            try {
                await loadStats();
                await loadUsers();
                await loadRankingGeral();
                updateToday();
                console.log('‚úÖ Inicializa√ß√£o completa');
                
                // Inicializar o painel de alerta de operadores
                if (typeof inicializarPainelAlerta === 'function') {
                    console.log('Chamando inicializarPainelAlerta...');
                    inicializarPainelAlerta();
                } else {
                    console.error('Fun√ß√£o inicializarPainelAlerta n√£o dispon√≠vel');
                    setTimeout(() => {
                        console.log('Tentando carregar operadores ap√≥s delay...');
                        if (typeof carregarRegistrosAdmin === 'function') {
                            carregarRegistrosAdmin();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        }

        // Auto-load on page ready
        init();
    </script>
    
    <!-- Remova essa linha se o script j√° estiver no head -->
    <!-- <script src="js/script.js?v=1.1"></script> -->
    
    <!-- Script para garantir que o painel de alerta seja inicializado -->
    <script>
        // Garantir que o painel de alerta seja inicializado ap√≥s tudo carregar
        window.addEventListener('load', function() {
            console.log('P√°gina totalmente carregada, verificando painel de alerta...');
            
            // Aguardar um momento para garantir que todos os scripts foram processados
            setTimeout(function() {
                // Verificar se a fun√ß√£o carregarRegistrosAdmin existe
                if (typeof carregarRegistrosAdmin === 'function') {
                    console.log('Chamando carregarRegistrosAdmin explicitamente...');
                    carregarRegistrosAdmin();
                } else {
                    console.error('Fun√ß√£o carregarRegistrosAdmin n√£o dispon√≠vel');
                }
                
                // Verificar se estamos na se√ß√£o de aten√ß√£o
                const secaoAtencao = document.getElementById('atencao');
                if (secaoAtencao && secaoAtencao.classList.contains('active')) {
                    console.log('Se√ß√£o de aten√ß√£o est√° ativa');
                } else {
                    console.log('Se√ß√£o de aten√ß√£o n√£o est√° ativa, ativando...');
                    showSection('atencao');
                }
            }, 1000);
        });
    </script>
    
    <!-- Modal para exibir todos os registros de um operador -->
    <div id="modal-registros" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modal-titulo">Registros do Operador</h3>
                <button class="modal-close-btn" onclick="fecharModalRegistros()">&times;</button>
            </div>
            <div class="modal-content">
                <div id="operador-estatisticas" class="operador-estatisticas">
                    <!-- Estat√≠sticas ser√£o preenchidas dinamicamente -->
                </div>
                <div class="registros-tabela-container">
                    <table class="registros-tabela">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>TMA</th>
                                <th>TMR</th>
                                <th>Conex√£o</th>
                                <th>Chamadas</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-registros-corpo">
                            <!-- Registros ser√£o preenchidos dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn-footer" onclick="fecharModalRegistros()">Fechar</button>
            </div>
        </div>
    </div>
</body>
</html>
