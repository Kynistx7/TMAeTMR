<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="device-width, initial-scale=1.0">
    <title>Admin - Sistema TMA/TMR</title>
    <link rel="stylesheet" href="css/admin-clean.css?v=3.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body class="admin-page">
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üõ†Ô∏è Painel Administrativo</h1>
            <p>Sistema TMA/TMR - Gest√£o Completa</p>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsuarios">-</div>
                <div class="stat-label">Total de Usu√°rios</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRegistros">-</div>
                <div class="stat-label">Total de Registros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tmaGeral">-</div>
                <div class="stat-label">TMA M√©dio Geral</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tmrGeral">-</div>
                <div class="stat-label">TMR M√©dio Geral</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showSection('usuarios')">üë• Usu√°rios</button>
            <button class="tab" onclick="showSection('top-tempos')">üèÜ Top 10</button>
            <button class="tab" onclick="showSection('relatorios')">üìã Relat√≥rios</button>
        </div>

        <!-- Usu√°rios Section -->
        <div id="usuarios" class="tab-content active">
            <h2>Gerenciamento de Usu√°rios</h2>
            <div id="usuariosList" class="loading">Carregando usu√°rios...</div>
        </div>

        <!-- Top 10 Section -->
        <div id="top-tempos" class="tab-content">
            <div class="top-section">
                <h3>üèÜ Ranking de Tempos - Melhores e Piores</h3>
                <div class="meta-info">
                    <p><strong>üìè Crit√©rios:</strong></p>
                    <p>‚Ä¢ <span class="tempo-bom">TMA ‚â§ 1:32 (92s)</span> e <span class="tempo-bom">TMR ‚â§ 6s</span> = Melhores Tempos</p>
                    <p>‚Ä¢ <span class="tempo-ruim">TMA > 1:32 (92s)</span> e <span class="tempo-ruim">TMR > 6s</span> = Piores Tempos</p>
                </div>
                
                <!-- Navigation Tabs -->
                <div class="top-tabs">
                    <button class="top-tab active" onclick="showRankingPeriod('geral')">üìä Ranking Geral</button>
                    <button class="top-tab" onclick="showRankingPeriod('diario')">üìÖ Ranking do Dia</button>
                </div>
            </div>
            
            <!-- Ranking Geral -->
            <div id="ranking-geral" class="top-container active">
                <div class="top-box best">
                    <h4>üéØ Melhores TMA (‚â§ 1:32)</h4>
                    <div id="melhoresTMAGeral" class="loading">Carregando...</div>
                </div>
                
                <div class="top-box worst">
                    <h4>‚ö†Ô∏è Piores TMA (> 1:32)</h4>
                    <div id="pioresTMAGeral" class="loading">Carregando...</div>
                </div>
                
                <div class="top-box best">
                    <h4>üéØ Melhores TMR (‚â§ 6s)</h4>
                    <div id="melhoresTMRGeral" class="loading">Carregando...</div>
                </div>
                
                <div class="top-box worst">
                    <h4>‚ö†Ô∏è Piores TMR (> 6s)</h4>
                    <div id="pioresTMRGeral" class="loading">Carregando...</div>
                </div>
            </div>
            
            <!-- Ranking Di√°rio -->
            <div id="ranking-diario" class="top-container">
                <div class="top-section">
                    <div class="date-selector">
                        <label for="seletorData">üìÖ Selecionar Data:</label>
                        <input type="date" id="seletorData" />
                        <button id="botaoHoje" class="date-today-btn">üìÖ Hoje</button>
                    </div>
                    
                    <div class="meta-info">
                        <p id="periodoAtual">üìÖ Hoje</p>
                        <p>Total de registros: <span id="totalRegistrosDia">-</span></p>
                    </div>
                </div>
                
                <div class="top-container">
                    <div class="top-box best">
                        <h4>üéØ Melhores TMA Hoje (‚â§ 1:32)</h4>
                        <div id="melhoresTMAHoje" class="loading">Carregando...</div>
                    </div>
                    
                    <div class="top-box worst">
                        <h4>‚ö†Ô∏è Piores TMA Hoje (> 1:32)</h4>
                        <div id="pioresTMAHoje" class="loading">Carregando...</div>
                    </div>
                    
                    <div class="top-box best">
                        <h4>üéØ Melhores TMR Hoje (‚â§ 6s)</h4>
                        <div id="melhoresTMRHoje" class="loading">Carregando...</div>
                    </div>
                    
                    <div class="top-box worst">
                        <h4>‚ö†Ô∏è Piores TMR Hoje (> 6s)</h4>
                        <div id="pioresTMRHoje" class="loading">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Section -->
        <div id="relatorios" class="tab-content">
            <h2>üìã Relat√≥rios e Gr√°ficos</h2>
            
            <!-- Controles de filtro -->
            <div class="report-filters">
                <div class="filter-group">
                    <label for="reportDateRange">üìÖ Per√≠odo:</label>
                    <select id="reportDateRange">
                        <option value="hoje">Hoje</option>
                        <option value="7dias">√öltimos 7 dias</option>
                        <option value="30dias" selected>√öltimos 30 dias</option>
                        <option value="personalizado">Per√≠odo personalizado</option>
                    </select>
                </div>
                
                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label for="dateFrom">De:</label>
                    <input type="date" id="dateFrom">
                    <label for="dateTo">At√©:</label>
                    <input type="date" id="dateTo">
                </div>
                
                <button class="filter-apply-btn" onclick="applyReportFilters()">üîÑ Aplicar Filtros</button>
            </div>
            
            <!-- Grid de gr√°ficos -->
            <div class="charts-grid">
                <!-- Gr√°fico TMA por Dia -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üìä TMA M√©dio por Dia</h3>
                        <div class="chart-meta">
                            <span class="meta-good">Meta: ‚â§ 92s</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tmaChart"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico TMR por Dia -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üìä TMR M√©dio por Dia</h3>
                        <div class="chart-meta">
                            <span class="meta-good">Meta: ‚â§ 6s</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tmrChart"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico Distribui√ß√£o TMA -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üéØ Distribui√ß√£o de TMA</h3>
                        <div class="chart-meta">
                            <span class="chart-info">Conformidade vs N√£o-conformidade</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tmaDistributionChart"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico Distribui√ß√£o TMR -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üéØ Distribui√ß√£o de TMR</h3>
                        <div class="chart-meta">
                            <span class="chart-info">Conformidade vs N√£o-conformidade</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tmrDistributionChart"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico Performance por Usu√°rio -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h3>üë• Performance por Usu√°rio</h3>
                        <div class="chart-meta">
                            <span class="chart-info">TMA e TMR m√©dios por usu√°rio</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="userPerformanceChart"></canvas>
                    </div>
                </div>
                
                <!-- Estat√≠sticas resumo -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h3>üìà Estat√≠sticas do Per√≠odo</h3>
                    </div>
                    <div class="stats-summary" id="statsSummary">
                        <div class="loading">Carregando estat√≠sticas...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};

        function showSection(sectionName) {
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(sectionName).classList.add('active');
            
            if (sectionName === 'top-tempos') {
                loadRankingGeral();
                updateToday();
            } else if (sectionName === 'relatorios') {
                loadReports();
            }
        }

        function showRankingPeriod(period) {
            document.querySelectorAll('.top-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.top-container').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`ranking-${period}`).classList.add('active');
            
            if (period === 'geral') {
                loadRankingGeral();
            } else if (period === 'diario') {
                updateToday();
                loadRankingDiario();
            }
        }

        function updateToday() {
            const today = new Date();
            const isoDate = today.toISOString().split('T')[0];
            document.getElementById('seletorData').value = isoDate;
        }

        function carregarHoje() {
            console.log('üè† Carregando dados de hoje...');
            updateToday();
            document.getElementById('periodoAtual').textContent = 'üìÖ Hoje';
            loadRankingDiario();
        }

        function carregarRankingPorData() {
            const dataInput = document.getElementById('seletorData');
            const dataSelecionada = dataInput.value;
            
            if (!dataSelecionada) {
                alert('‚ö†Ô∏è Por favor, selecione uma data v√°lida!');
                return;
            }
            
            console.log('üìÖ Carregando ranking para data:', dataSelecionada);
            
            const [ano, mes, dia] = dataSelecionada.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            document.getElementById('periodoAtual').textContent = `üìÖ Data: ${dataFormatada}`;
            
            loadRankingPorData(dataSelecionada);
        }

        async function loadStats() {
            try {
                console.log('üìä Carregando estat√≠sticas...');
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);
                
                document.getElementById('totalUsuarios').textContent = data.total_usuarios || '0';
                document.getElementById('totalRegistros').textContent = data.total_registros || '0';
                document.getElementById('tmaGeral').textContent = (data.tma_geral || '0') + 's';
                document.getElementById('tmrGeral').textContent = (data.tmr_geral || '0') + 's';
                
                currentData.stats = data;
                console.log('‚úÖ Estat√≠sticas carregadas');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                document.getElementById('totalUsuarios').textContent = '0';
                document.getElementById('totalRegistros').textContent = '0';
                document.getElementById('tmaGeral').textContent = '0s';
                document.getElementById('tmrGeral').textContent = '0s';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/usuarios');
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);
                
                const container = document.getElementById('usuariosList');
                container.innerHTML = '';
                
                data.usuarios.forEach(usuario => {
                    const userDiv = document.createElement('div');
                    userDiv.style.cssText = `
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    `;
                    userDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.1rem; color: #1f2937;">${usuario.nome}</strong>
                                ${usuario.is_admin ? '<span style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">ADMIN</span>' : ''}
                                <div style="color: #6b7280; margin-top: 5px;">${usuario.total_registros} registros</div>
                            </div>
                            ${!usuario.is_admin ? `<button onclick="deleteUser(${usuario.id}, '${usuario.nome}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Deletar</button>` : ''}
                        </div>
                    `;
                    container.appendChild(userDiv);
                });
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuariosList').innerHTML = '<div class="admin-error">Erro ao carregar usu√°rios: ' + error.message + '</div>';
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`Tem certeza que deseja deletar o usu√°rio "${userName}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/usuarios/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.erro) throw new Error(data.erro);
                
                alert(data.message);
                await loadUsers();
                await loadStats();
                
            } catch (error) {
                alert('Erro ao deletar usu√°rio: ' + error.message);
            }
        }

        async function loadRankingGeral() {
            try {
                const response = await fetch('/api/admin/top-tempos');
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);

                console.log('üîç DEBUG - Ranking Geral:', data);
                
                // Melhores TMA
                const melhoresTMAGeral = document.getElementById('melhoresTMAGeral');
                if (data.melhores_tma.length === 0) {
                    melhoresTMAGeral.innerHTML = '<div class="empty-message">üì≠ Nenhum TMA ‚â§ 1:32 encontrado</div>';
                } else {
                    melhoresTMAGeral.innerHTML = createRankingTable(
                        data.melhores_tma.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tma}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'good'
                        }))
                    );
                }
                
                // Piores TMA
                const pioresTMAGeral = document.getElementById('pioresTMAGeral');
                if (data.piores_tma.length === 0) {
                    pioresTMAGeral.innerHTML = '<div class="empty-message">üéâ Excelente! Todos os TMA est√£o dentro da meta!</div>';
                } else {
                    pioresTMAGeral.innerHTML = createRankingTable(
                        data.piores_tma.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tma}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'bad'
                        }))
                    );
                }
                
                // Melhores TMR
                const melhoresTMRGeral = document.getElementById('melhoresTMRGeral');
                if (data.melhores_tmr.length === 0) {
                    melhoresTMRGeral.innerHTML = '<div class="empty-message">üì≠ Nenhum TMR ‚â§ 6s encontrado</div>';
                } else {
                    melhoresTMRGeral.innerHTML = createRankingTable(
                        data.melhores_tmr.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tmr}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'good'
                        }))
                    );
                }
                
                // Piores TMR
                const pioresTMRGeral = document.getElementById('pioresTMRGeral');
                if (data.piores_tmr.length === 0) {
                    pioresTMRGeral.innerHTML = '<div class="empty-message">üéâ Excelente! Todos os TMR est√£o dentro da meta!</div>';
                } else {
                    pioresTMRGeral.innerHTML = createRankingTable(
                        data.piores_tmr.map((r, i) => ({
                            pos: i + 1,
                            operador: r.nome_operador,
                            pdv: r.numero_pdv,
                            tempo: `${r.tmr}s`,
                            data: r.data_registro,
                            usuario: r.usuario_nome,
                            tipo: 'bad'
                        }))
                    );
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking geral:', error);
                document.querySelectorAll('#ranking-geral .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        async function loadRankingPorData(dataSelecionada) {
            try {
                const response = await fetch(`/api/admin/top-tempos-diario?data=${dataSelecionada}`);
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);

                console.log('üîç DEBUG - Ranking por Data:', data);
                
                document.getElementById('totalRegistrosDia').textContent = data.total_registros_hoje;
                
                // Melhores TMA da Data
                const melhoresTMAHoje = document.getElementById('melhoresTMAHoje');
                if (!data.melhores_tma_hoje || data.melhores_tma_hoje.length === 0) {
                    melhoresTMAHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMA ‚â§ 1:32 nesta data</div>';
                } else {
                    const rankingData = data.melhores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMA da Data
                const pioresTMAHoje = document.getElementById('pioresTMAHoje');
                if (!data.piores_tma_hoje || data.piores_tma_hoje.length === 0) {
                    pioresTMAHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMA acima da meta nesta data!</div>';
                } else {
                    const rankingData = data.piores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Melhores TMR da Data
                const melhoresTMRHoje = document.getElementById('melhoresTMRHoje');
                if (!data.melhores_tmr_hoje || data.melhores_tmr_hoje.length === 0) {
                    melhoresTMRHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMR ‚â§ 6s nesta data</div>';
                } else {
                    const rankingData = data.melhores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMR da Data
                const pioresTMRHoje = document.getElementById('pioresTMRHoje');
                if (!data.piores_tmr_hoje || data.piores_tmr_hoje.length === 0) {
                    pioresTMRHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMR acima da meta nesta data!</div>';
                } else {
                    const rankingData = data.piores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking por data:', error);
                document.querySelectorAll('#ranking-diario .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        async function loadRankingDiario() {
            try {
                const response = await fetch('/api/admin/top-tempos-diario');
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);

                console.log('üîç DEBUG - Ranking Di√°rio:', data);
                
                document.getElementById('totalRegistrosDia').textContent = data.total_registros_hoje;
                
                // Melhores TMA Hoje
                const melhoresTMAHoje = document.getElementById('melhoresTMAHoje');
                if (!data.melhores_tma_hoje || data.melhores_tma_hoje.length === 0) {
                    melhoresTMAHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMA ‚â§ 1:32 hoje</div>';
                } else {
                    const rankingData = data.melhores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMA Hoje
                const pioresTMAHoje = document.getElementById('pioresTMAHoje');
                if (!data.piores_tma_hoje || data.piores_tma_hoje.length === 0) {
                    pioresTMAHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMA acima da meta hoje!</div>';
                } else {
                    const rankingData = data.piores_tma_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tma}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMAHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Melhores TMR Hoje
                const melhoresTMRHoje = document.getElementById('melhoresTMRHoje');
                if (!data.melhores_tmr_hoje || data.melhores_tmr_hoje.length === 0) {
                    melhoresTMRHoje.innerHTML = '<div class="empty-ranking">üì≠ Nenhum TMR ‚â§ 6s hoje</div>';
                } else {
                    const rankingData = data.melhores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'good'
                    }));
                    melhoresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
                // Piores TMR Hoje
                const pioresTMRHoje = document.getElementById('pioresTMRHoje');
                if (!data.piores_tmr_hoje || data.piores_tmr_hoje.length === 0) {
                    pioresTMRHoje.innerHTML = '<div class="excellent-ranking">üéâ Nenhum TMR acima da meta hoje!</div>';
                } else {
                    const rankingData = data.piores_tmr_hoje.map((r, i) => ({
                        pos: i + 1,
                        operador: r.nome_operador,
                        pdv: r.numero_pdv,
                        tempo: `${r.tmr}s`,
                        usuario: r.usuario_nome,
                        tipo: 'bad'
                    }));
                    pioresTMRHoje.innerHTML = createRankingTable(rankingData);
                }
                
            } catch (error) {
                console.error('Erro ao carregar ranking di√°rio:', error);
                document.querySelectorAll('#ranking-diario .ranking-content').forEach(el => {
                    el.innerHTML = '<div class="error-ranking">‚ùå Erro: ' + error.message + '</div>';
                });
            }
        }

        function createRankingTable(rankings) {
            if (rankings.length === 0) {
                return '<div class="empty-message">üì≠ Nenhum registro encontrado</div>';
            }
            
            const html = `
                <table class="top-table">
                    <thead>
                        <tr>
                            <th class="ranking-pos">Pos</th>
                            <th>Operador</th>
                            <th>PDV</th>
                            <th>Tempo</th>
                            <th>Usu√°rio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rankings.map(r => `
                            <tr>
                                <td class="ranking-pos">${r.pos}¬∞</td>
                                <td>${r.operador}</td>
                                <td>${r.pdv}</td>
                                <td class="tempo-destaque ${r.tipo === 'good' ? 'tempo-bom' : 'tempo-ruim'}">${r.tempo}</td>
                                <td>üë§ ${r.usuario}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            return html;
        }

        function loadReports() {
            console.log('üìä Carregando relat√≥rios e gr√°ficos...');
            applyReportFilters();
        }

        async function applyReportFilters() {
            const dateRange = document.getElementById('reportDateRange').value;
            const customDateGroup = document.getElementById('customDateGroup');
            
            // Mostrar/ocultar campos de data personalizada
            if (dateRange === 'personalizado') {
                customDateGroup.style.display = 'flex';
            } else {
                customDateGroup.style.display = 'none';
            }
            
            let startDate, endDate;
            const today = new Date();
            
            switch(dateRange) {
                case 'hoje':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case '7dias':
                    startDate = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case '30dias':
                    startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'personalizado':
                    startDate = document.getElementById('dateFrom').value;
                    endDate = document.getElementById('dateTo').value;
                    if (!startDate || !endDate) {
                        alert('‚ö†Ô∏è Por favor, selecione as datas de in√≠cio e fim');
                        return;
                    }
                    break;
            }
            
            await loadChartData(startDate, endDate);
        }

        async function loadChartData(startDate, endDate) {
            try {
                console.log(`üìä Carregando dados de ${startDate} at√© ${endDate}`);
                
                const response = await fetch(`/api/admin/chart-data?start=${startDate}&end=${endDate}`);
                const data = await response.json();
                
                if (data.erro) throw new Error(data.erro);
                
                console.log('üìä Dados dos gr√°ficos:', data);
                
                // Criar gr√°ficos
                createTMAChart(data.tma_por_dia);
                createTMRChart(data.tmr_por_dia);
                createTMADistributionChart(data.tma_distribution);
                createTMRDistributionChart(data.tmr_distribution);
                createUserPerformanceChart(data.user_performance);
                updateStatsSummary(data.stats_summary);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados dos gr√°ficos:', error);
                showChartsError(error.message);
            }
        }

        let charts = {}; // Armazenar inst√¢ncias dos gr√°ficos

        function createTMAChart(data) {
            const ctx = document.getElementById('tmaChart').getContext('2d');
            
            if (charts.tma) {
                charts.tma.destroy();
            }
            
            charts.tma = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.data)),
                    datasets: [{
                        label: 'TMA M√©dio (s)',
                        data: data.map(d => d.tma_medio),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Meta (92s)',
                        data: data.map(() => 92),
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tempo (segundos)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function createTMRChart(data) {
            const ctx = document.getElementById('tmrChart').getContext('2d');
            
            if (charts.tmr) {
                charts.tmr.destroy();
            }
            
            charts.tmr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.data)),
                    datasets: [{
                        label: 'TMR M√©dio (s)',
                        data: data.map(d => d.tmr_medio),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Meta (6s)',
                        data: data.map(() => 6),
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tempo (segundos)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    }
                }
            });
        }

        function createTMADistributionChart(data) {
            const ctx = document.getElementById('tmaDistributionChart').getContext('2d');
            
            if (charts.tmaDistribution) {
                charts.tmaDistribution.destroy();
            }
            
            charts.tmaDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Dentro da Meta (‚â§ 92s)', 'Acima da Meta (> 92s)'],
                    datasets: [{
                        data: [data.dentro_meta, data.acima_meta],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTMRDistributionChart(data) {
            const ctx = document.getElementById('tmrDistributionChart').getContext('2d');
            
            if (charts.tmrDistribution) {
                charts.tmrDistribution.destroy();
            }
            
            charts.tmrDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Dentro da Meta (‚â§ 6s)', 'Acima da Meta (> 6s)'],
                    datasets: [{
                        data: [data.dentro_meta, data.acima_meta],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createUserPerformanceChart(data) {
            const ctx = document.getElementById('userPerformanceChart').getContext('2d');
            
            if (charts.userPerformance) {
                charts.userPerformance.destroy();
            }
            
            charts.userPerformance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.usuario),
                    datasets: [{
                        label: 'TMA M√©dio (s)',
                        data: data.map(d => d.tma_medio),
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: '#4f46e5',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'TMR M√©dio (s)',
                        data: data.map(d => d.tmr_medio),
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'TMA (segundos)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'TMR (segundos)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateStatsSummary(stats) {
            const container = document.getElementById('statsSummary');
            
            container.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-icon">üìä</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.total_registros}</div>
                            <div class="summary-label">Total de Registros</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">‚è±Ô∏è</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.tma_medio}s</div>
                            <div class="summary-label">TMA M√©dio</div>
                            <div class="summary-meta ${stats.tma_medio <= 92 ? 'good' : 'bad'}">
                                ${stats.tma_medio <= 92 ? '‚úÖ Dentro da meta' : '‚ö†Ô∏è Acima da meta'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">üîÑ</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.tmr_medio}s</div>
                            <div class="summary-label">TMR M√©dio</div>
                            <div class="summary-meta ${stats.tmr_medio <= 6 ? 'good' : 'bad'}">
                                ${stats.tmr_medio <= 6 ? '‚úÖ Dentro da meta' : '‚ö†Ô∏è Acima da meta'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">üéØ</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.conformidade_tma}%</div>
                            <div class="summary-label">Conformidade TMA</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">üéØ</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.conformidade_tmr}%</div>
                            <div class="summary-label">Conformidade TMR</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-icon">üë•</div>
                        <div class="summary-content">
                            <div class="summary-value">${stats.usuarios_ativos}</div>
                            <div class="summary-label">Usu√°rios Ativos</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function showChartsError(message) {
            document.querySelectorAll('.chart-container canvas').forEach(canvas => {
                const container = canvas.parentElement;
                container.innerHTML = `
                    <div class="chart-error">
                        <div class="error-icon">‚ùå</div>
                        <div class="error-message">Erro ao carregar gr√°fico: ${message}</div>
                    </div>
                `;
            });
        }

        // Event listener para mudan√ßa no per√≠odo
        document.addEventListener('DOMContentLoaded', function() {
            const reportDateRange = document.getElementById('reportDateRange');
            if (reportDateRange) {
                reportDateRange.addEventListener('change', function() {
                    if (this.value !== 'personalizado') {
                        applyReportFilters();
                    }
                });
            }
        });

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro no logout:', error);
                window.location.href = '/login';
            }
        }

        async function init() {
            console.log('üöÄ Iniciando admin...');
            try {
                await loadStats();
                await loadUsers();
                await loadRankingGeral();
                updateToday();
                console.log('‚úÖ Inicializa√ß√£o completa');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin page loaded - Initializing...');
            
            updateToday();
            init();
            
            const dataInput = document.getElementById('seletorData');
            if (dataInput) {
                dataInput.addEventListener('change', carregarRankingPorData);
                console.log('üìÖ Date selector listener added');
            }
            
            const botaoHoje = document.getElementById('botaoHoje');
            if (botaoHoje) {
                botaoHoje.addEventListener('click', carregarHoje);
                console.log('üìÖ Today button listener added');
            }
        });

        // Auto-load
        init();
    </script>
</body>
</html>
