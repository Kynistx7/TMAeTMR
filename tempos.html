<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C√°lculo de TMA e TMR</title>
  <link rel="stylesheet" href="css/temp.css">
  
  <style>
    /* Estilos para o campo "Outros" - igual aos outros campos */
    #outro-operador-container {
      display: none; /* Inicialmente oculto */
    }
    
    /* Estilo padronizado para o select de nome do operador */
    #nome {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      height: 38px;
      background-color: white;
      appearance: none; /* Remove estilos nativos de alguns navegadores */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23444' d='M3.8 4.4c-.3-.3-.8-.3-1 0-.3.3-.3.8 0 1l2.6 2.6c.3.3.8.3 1 0l2.6-2.6c.3-.3.3-.8 0-1-.3-.3-.8-.3-1 0L6 6.3 3.8 4.4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px; /* Espa√ßo para o √≠cone de seta */
    }
    
    /* Estado de foco do select */
    #nome:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    
    /* O input segue o mesmo estilo dos outros inputs do sistema */
    #outro-operador {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      height: 38px; /* Altura padr√£o para combinar com outros campos */
      appearance: none; /* Remove estilos nativos de alguns navegadores */
      background-color: white;
    }
    
    /* Estado de foco igual aos outros campos */
    #outro-operador:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    
    /* Para garantir que o container tenha o mesmo espa√ßamento */
    #outro-operador-container.form-group {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-logo">
        <img src="img/boa.png" alt="Logo" class="logo-img">
        <div class="header-text">
          <h1>Sistema TMA e TMR</h1>
          <p>C√°lculo de Tempo M√©dio de Atendimento e Tempo M√©dio por Item</p>
        </div>
      </div>
    </div>
    
    <div class="toolbar">
      <button id="exportar-csv" type="button" class="btn-warning">üìä Exportar CSV</button>
      <input type="file" id="importar-csv" accept=".csv" style="display:none;">
      <button onclick="document.getElementById('importar-csv').click()" class="btn-warning">üìÅ Importar CSV</button>
      <button id="teste-usuario" type="button" class="btn-primary">üîç Testar Usu√°rio</button>
      <button id="recarregar-dados" type="button" class="btn-success">üîÑ Recarregar</button>
      <button id="admin-btn" type="button" class="btn-admin" style="display:none;" onclick="window.location.href='/admin'">üõ†Ô∏è Admin</button>
    </div>
    
    <div class="content">
      <div class="info-box">
        <h4>üìã Como calcular:</h4>
        <p><strong>TMA (Tempo M√©dio de Atendimento):</strong> (TV + TR) √∑ Quantidade de Cupons</p>
        <p><strong>TMR (Tempo M√©dio por Item):</strong> TV √∑ Quantidade de Itens</p>
        <p><small>TV = Tempo de Venda | TR = Tempo de Recebimento | Metas: TMA ‚â§ 1,32 min/cupom | TMR ‚â§ 6,00 seg/item</small></p>
      </div>
      
      <div class="form-container">
        <form id="form" class="form-grid">
          <div class="form-group">
            <label for="nome">Nome do Operador</label>
            <select id="nome" required>
              <option value="" disabled selected>Selecione um operador</option>
              <!-- Operadores pr√©-cadastrados -->
              <option value="Maria Raiane">Maria Raiane</option>
              <option value="Lucas Henrique">Lucas Henrique</option>
              <option value="Gustavo">Gustavo</option>
              <option value="Adriana">Adriana</option>
              <option value="Davi Andreta">Davi Andreta</option>
              <option value="Davi Domiciano">Davi Domiciano</option>
              <option value="Anna Carolina">Anna Carolina</option>
              <option value="Leticia">Leticia</option>
              <option value="Levi">Levi</option>
              <option value="Yndrigo">Yndrigo</option>
              <option value="Lucas Almeida">Lucas Almeida</option>
              <option value="Marcela">Marcela</option>
              <option value="Rosangela">Rosangela</option>
              <option value="Nirian">Nirian</option>
              <option value="Giovana">Giovana</option>
              <option value="Andreia">Andreia</option>
              <option value="Adonane">Adonane</option>
              <option value="outros">-- Outros --</option>
            </select>
          </div>
          
          <div class="form-group" id="outro-operador-container">
            <label for="outro-operador">Nome do Operador (Outros)</label>
            <input type="text" id="outro-operador" placeholder="Digite o nome do operador">
          </div>
          
          <div class="form-group">
            <label for="data_registro">Data do Registro</label>
            <input type="date" id="data_registro" required>
          </div>
          
          <div class="form-group">
            <label for="numero_pdv">N√∫mero do PDV</label>
            <input type="text" id="numero_pdv" placeholder="Ex: PDV001 ou 001" required>
          </div>
          
          <div class="form-group">
            <label for="tv">Tempo de Venda (TV)</label>
            <input type="time" step="1" id="tv" required>
          </div>
          
          <div class="form-group">
            <label for="tr">Tempo de Recebimento (TR)</label>
            <input type="time" step="1" id="tr" required>
          </div>
          
          <div class="form-group">
            <label for="cupons">Quantidade de Cupons</label>
            <input type="number" id="cupons" placeholder="Ex: 5" min="1" required>
          </div>
          
          <div class="form-group">
            <label for="itens">Quantidade de Itens</label>
            <input type="number" id="itens" placeholder="Ex: 25" min="1" required>
          </div>
          
          <button type="submit" class="btn-submit">üìù Registrar Dados</button>
        </form>
      </div>
      
      <div class="results-section">
        <h3 class="results-header">üìä Resultados dos Operadores</h3>
        <div class="table-container" style="max-height: 400px; overflow-y: auto; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <table class="results-table">
            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
              <tr>
                <th>Nome do Operador</th>
                <th>Data</th>
                <th>PDV</th>
                <th>TMA<br><small>(min/cupom)</small></th>
                <th>TMR<br><small>(seg/item)</small></th>
                <th>Status Geral</th>
              </tr>
            </thead>
            <tbody id="tabela">
              <tr>
                <td colspan="6" style="text-align: center; color: #666; padding: 2rem;">
                  Nenhum registro encontrado. Adicione dados usando o formul√°rio acima.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="js/script.js"></script>
  
  <script>
    // Script para controlar o campo "Outros"
    document.addEventListener('DOMContentLoaded', function() {
      const selectNome = document.getElementById('nome');
      const outroOperadorContainer = document.getElementById('outro-operador-container');
      const outroOperadorInput = document.getElementById('outro-operador');
      
      // Definir data padr√£o como hoje
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data_registro').value = hoje;
      
      // Configurar bot√£o de exporta√ß√£o CSV
      const exportarCsvBtn = document.getElementById('exportar-csv');
      if (exportarCsvBtn) {
        exportarCsvBtn.addEventListener('click', exportarParaCSV);
      }
      
      // Monitorar mudan√ßas na sele√ß√£o
      selectNome.addEventListener('change', function() {
        if (this.value === 'outros') {
          outroOperadorContainer.style.display = 'block';
          outroOperadorInput.setAttribute('required', 'required');
          
          // Foco autom√°tico no campo de texto
          setTimeout(() => {
            outroOperadorInput.focus();
          }, 50);
        } else {
          outroOperadorContainer.style.display = 'none';
          outroOperadorInput.removeAttribute('required');
        }
      });
      
      // Modificar o comportamento do formul√°rio para usar o valor do campo "Outros" quando selecionado
      const form = document.getElementById('form');
      form.addEventListener('submit', function(event) {
        if (selectNome.value === 'outros' && outroOperadorInput.value.trim()) {
          // Substituir o valor do select pelo texto inserido em "Outros"
          selectNome.value = outroOperadorInput.value.trim();
        }
      });
      
      // Configurar importa√ß√£o de CSV
      const importarCsv = document.getElementById('importar-csv');
      if (importarCsv) {
        importarCsv.addEventListener('change', function(event) {
          const arquivo = event.target.files[0];
          if (arquivo) {
            processarArquivoCSV(arquivo);
          }
        });
      }
    });
    
    // Fun√ß√£o para exportar dados para CSV
    async function exportarParaCSV() {
      if (!user_id) {
        alert('Voc√™ precisa estar logado para exportar dados.');
        return;
      }
      
      try {
        console.log('Obtendo dados para exporta√ß√£o...');
        const resposta = await fetch(`/api/registros/${user_id}`);
        
        if (!resposta.ok) {
          throw new Error(`Erro HTTP: ${resposta.status}`);
        }
        
        const registros = await resposta.json();
        
        if (registros.length === 0) {
          alert('N√£o h√° registros para exportar.');
          return;
        }
        
        // Criar conte√∫do CSV
        let csvConteudo = 'nome_operador,data_registro,numero_pdv,tma,tmr\n';
        
        registros.forEach(reg => {
          csvConteudo += `${reg.nome_operador || ''},${reg.data_registro || ''},${reg.numero_pdv || ''},${reg.tma || ''},${reg.tmr || ''}\n`;
        });
        
        // Criar blob e download
        const blob = new Blob([csvConteudo], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        // Criar nome de arquivo com data atual
        const dataAtual = new Date().toISOString().slice(0, 10);
        const nomeArquivo = `tma_tmr_export_${dataAtual}.csv`;
        
        // Configurar download
        if (navigator.msSaveBlob) { // Para IE e Edge
          navigator.msSaveBlob(blob, nomeArquivo);
        } else {
          const url = URL.createObjectURL(blob);
          link.href = url;
          link.download = nomeArquivo;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        
        console.log('Exporta√ß√£o conclu√≠da!');
        alert(`Exporta√ß√£o conclu√≠da! ${registros.length} registros exportados.`);
      } catch (error) {
        console.error('Erro durante exporta√ß√£o CSV:', error);
        alert('Erro ao exportar dados: ' + error.message);
      }
    }
    
    // Fun√ß√£o para processar arquivo CSV importado
    function processarArquivoCSV(arquivo) {
      console.log('Processando arquivo CSV:', arquivo.name);
      
      const leitor = new FileReader();
      
      leitor.onload = async function(e) {
        try {
          const conteudo = e.target.result;
          const linhas = conteudo.split('\n');
          
          // Verificar se h√° dados suficientes
          if (linhas.length < 2) {
            alert('Arquivo CSV inv√°lido ou vazio.');
            return;
          }
          
          // Verificar cabe√ßalho (primeira linha)
          const cabecalho = linhas[0].toLowerCase().split(',');
          const indices = {
            nome: cabecalho.indexOf('nome_operador'),
            data: cabecalho.indexOf('data_registro'),
            pdv: cabecalho.indexOf('numero_pdv'),
            tma: cabecalho.indexOf('tma'),
            tmr: cabecalho.indexOf('tmr')
          };
          
          // Verificar se todos os campos necess√°rios existem
          if (Object.values(indices).includes(-1)) {
            alert('Formato CSV inv√°lido. O cabe√ßalho deve conter: nome_operador, data_registro, numero_pdv, tma, tmr');
            return;
          }
          
          // Processar linhas de dados
          const registros = [];
          const erros = [];
          
          for (let i = 1; i < linhas.length; i++) {
            if (!linhas[i].trim()) continue; // Pular linhas vazias
            
            const valores = linhas[i].split(',');
            
            // Verificar se a linha tem todas as colunas
            if (valores.length !== cabecalho.length) {
              erros.push(`Linha ${i+1}: n√∫mero incorreto de colunas`);
              continue;
            }
            
            // Criar objeto de registro
            const registro = {
              nome_operador: valores[indices.nome],
              data_registro: valores[indices.data],
              numero_pdv: valores[indices.pdv],
              tma: parseFloat(valores[indices.tma]),
              tmr: parseFloat(valores[indices.tmr]),
              user_id: parseInt(localStorage.getItem('user_id'))
            };
            
            // Validar valores
            if (isNaN(registro.tma) || isNaN(registro.tmr)) {
              erros.push(`Linha ${i+1}: TMA ou TMR inv√°lidos`);
              continue;
            }
            
            registros.push(registro);
          }
          
          // Mostrar resumo antes de enviar
          const confirmacao = confirm(
            `Encontrados ${registros.length} registros para importar.\n` +
            `${erros.length > 0 ? erros.length + ' linhas com erros.\n' : ''}` +
            'Deseja continuar com a importa√ß√£o?'
          );
          
          if (!confirmacao) {
            return;
          }
          
          // Enviar registros um por um
          let sucessos = 0;
          let falhas = 0;
          
          for (const registro of registros) {
            try {
              const response = await fetch("/api/registros", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify(registro)
              });
              
              if (response.ok) {
                sucessos++;
              } else {
                falhas++;
                console.error('Falha ao importar registro:', registro);
              }
            } catch (error) {
              falhas++;
              console.error('Erro na requisi√ß√£o:', error);
            }
          }
          
          // Mostrar resultado
          alert(`Importa√ß√£o conclu√≠da!\n${sucessos} registros importados com sucesso.\n${falhas} falhas.`);
          
          // Limpar campo de arquivo
          importarCsv.value = '';
          
          // Recarregar dados na tabela
          if (sucessos > 0) {
            carregarRegistros();
          }
          
        } catch (error) {
          console.error('Erro ao processar CSV:', error);
          alert('Erro ao processar o arquivo CSV: ' + error.message);
        }
      };
      
      leitor.onerror = function() {
        alert('Erro ao ler o arquivo.');
      };
      
      leitor.readAsText(arquivo);
    }
  </script>
</body>
</html>